language: ruby  
cache: bundler
rvm:
 - 2.2
services:
  - docker
branches:
 only:
  - master
  - stable
before_install:
 - mkdir data
 - mkdir report
 - chmod 777 data report
 - echo $PWD
 - ls
 - docker pull owasp/dependency-check
 - docker run --volume $PWD:/src --volume $PWD/data:/usr/share/dependency-check/data --volume $PWD/report:/report owasp/dependency-check --scan /src --format "ALL" --project "Cryptopus OWASP Dependency Check" --out /report
 - ls $PWD/report/dependency-check-report.html
 - cat $PWD/report/dependency-check-report.html
 - |
   grep -oh '"vulnerableCount">\d+' $PWD/report/dependency-check-report.html
   grep '"vulnerableCount">0<' $PWD/report/dependency-check-report.html
   if [[ $? -ne 0 ]]; then
     echo "ERROR! Vulnerability found by OWASP Dependency Checker. Build aborted. See above."
     exit 1
   fi
 - sudo service mysql restart
install:
 - bundle install --path vendor/bundle
before_script:
 - bundle exec rake db:create
 - bundle exec rake db:setup
 - bundle exec rake db:migrate
 - bundle exec rake geo:fetch
script:
 - bundle --deployment
 - bundle exec rake ci --trace

